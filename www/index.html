<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>PedidoApp JQM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Política de seguridad para Cordova -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src * 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval';
                 style-src * 'self' 'unsafe-inline';
                 script-src * 'self' 'unsafe-inline' 'unsafe-eval';
                 media-src *">

  <!-- jQuery y jQuery Mobile -->
  <link rel="stylesheet"
        href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
  <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
  <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>

  <!-- Cordova -->
  <script src="cordova.js"></script>
</head>
<body>

<!-- Página principal -->
<div data-role="page" id="pedidos">
  <div data-role="header">
    <h1>Pedidos en curso</h1>
  </div>

  <div role="main" class="ui-content">
    <a href="#" id="btn-refresh"
       class="ui-btn ui-corner-all ui-shadow ui-icon-refresh ui-btn-icon-left">
      Refrescar pedidos
    </a>
    <ul data-role="listview" id="lista-pedidos"></ul>

    <h3>Productos del pedido</h3>
    <ul data-role="listview" id="lista-productos"></ul>
  </div>
</div>

<script>
const API_URL = "https://www.ferroclimaexpress.com/api";
const WS_KEY = "B4KYF7LZ714FYZ5KADYM6TZCCKCVS4Q7";
const CARRIER_ID = 6;

const ESTADOS_PEDIDO = {
  1: "Pendiente de pago",
  2: "Pago aceptado",
  3: "Preparacion en curso",
  4: "Enviado",
  5: "Listo para entregar",
  6: "Entregado",
  7: "Cancelado"
};

let pedidosCache = [];

// Función auxiliar para obtener datos de cliente
function obtenerCliente(idCliente, callback) {
  const url = `${API_URL}/customers/${idCliente}?ws_key=${WS_KEY}&output_format=JSON`;
  cordova.plugin.http.sendRequest(url, { method: "get" }, function(resp) {
    try {
      const data = JSON.parse(resp.data);
      callback(null, data.customer || {});
    } catch(e) { callback(e, {}); }
  }, function(err) { callback(err, {}); });
}

// Función auxiliar para obtener datos de dirección
function obtenerDireccion(idDireccion, callback) {
  const url = `${API_URL}/addresses/${idDireccion}?ws_key=${WS_KEY}&output_format=JSON`;
  cordova.plugin.http.sendRequest(url, { method: "get" }, function(resp) {
    try {
      const data = JSON.parse(resp.data);
      callback(null, data.address || {});
    } catch(e) { callback(e, {}); }
  }, function(err) { callback(err, {}); });
}

function obtenerPedidosCompletos(idCarrier, callback) {
  const url = `${API_URL}/orders?ws_key=${WS_KEY}&output_format=JSON&filter[id_carrier]=${idCarrier}&display=full`;

  cordova.plugin.http.sendRequest(url, { method: "get", headers: { "Accept": "application/json" } }, function(response) {
    try {
      const data = JSON.parse(response.data);
      const orders = data.orders || [];
      callback(null, orders);
    } catch (e) { callback(e, []); }
  }, function(error) { callback(error, []); });
}

function procesarPedidos(idCarrier, callback) {
  obtenerPedidosCompletos(idCarrier, function(err, pedidos) {
    if (err) { callback(err, []); return; }

    const filtrados = pedidos.filter(p =>
      ESTADOS_PEDIDO[parseInt(p.current_state)] === "Preparacion en curso"
    );

    // Enriquecer cada pedido con datos de cliente y dirección
    let enriquecidos = [];
    let pendientes = filtrados.length;

    if (pendientes === 0) { callback(null, []); return; }

    filtrados.forEach(p => {
      obtenerCliente(p.id_customer, function(errC, cliente) {
        obtenerDireccion(p.id_address_delivery, function(errD, direccion) {
          enriquecidos.push({
            id: p.id,
            cliente: `${cliente.firstname || ""} ${cliente.lastname || ""}`,
            telefono: direccion.phone || direccion.phone_mobile || "Teléfono no disponible",
            direccion: `${direccion.address1 || ""}, ${direccion.postcode || ""} ${direccion.city || ""}`,
            total: p.total_paid,
            productos: p.associations?.order_rows || [],
            estado: ESTADOS_PEDIDO[parseInt(p.current_state)] || "Desconocido"
          });
          pendientes--;
          if (pendientes === 0) callback(null, enriquecidos);
        });
      });
    });
  });
}

function cargarPedidos() {
  $("#lista-pedidos").empty().append("<li>Cargando...</li>").listview("refresh");
  procesarPedidos(CARRIER_ID, function(err, pedidos) {
    $("#lista-pedidos").empty();
    if (err) {
      $("#lista-pedidos").append("<li>Error al cargar pedidos</li>").listview("refresh");
      return;
    }
    if (pedidos.length === 0) {
      $("#lista-pedidos").append("<li>No existen pedidos en 'Preparacion en curso'</li>");
    } else {
      pedidosCache = pedidos;
      pedidos.forEach(p => {
        $("#lista-pedidos").append(
          `<li>
             <h2>Pedido #${p.id}</h2>
             <p>${p.cliente} (${p.telefono})</p>
             <p>${p.direccion}</p>
             <p>Total: ${p.total} | Estado: ${p.estado}</p>
             <a href="#" onclick="mostrarProductos(${p.id})"
                class="ui-btn ui-mini">Ver productos</a>
           </li>`
        );
      });
    }
    $("#lista-pedidos").listview("refresh");
  });
}

function mostrarProductos(pedidoId) {
  const pedido = pedidosCache.find(p => p.id == pedidoId);
  $("#lista-productos").empty();
  if (pedido && pedido.productos.length > 0) {
    pedido.productos.forEach(row => {
      $("#lista-productos").append(
        `<li>${row.product_name} x${row.product_quantity} - ${row.unit_price_tax_incl}</li>`
      );
    });
  } else {
    $("#lista-productos").append("<li>Este pedido no tiene productos asociados</li>");
  }
  $("#lista-productos").listview("refresh");
}

// Esperar a que Cordova esté listo
document.addEventListener("deviceready", function() {
  alert("Cordova listo, plugin HTTP disponible");

  $(document).ready(function() {
    $("#btn-refresh").on("click", function() {
      alert("Me distes click");
      cargarPedidos();
    });
  });

  $(document).on("pageshow", "#pedidos", function() {
    cargarPedidos();
  });
}, false);
</script>

</body>
</html>
